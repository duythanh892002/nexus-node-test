name: nexus testnet node

on:
  workflow_dispatch:          # Cho phép chạy thủ công
  schedule:
    - cron: "0 */6 * * *"     # Tự chạy mỗi 6 tiếng

jobs:
  run-node:
    runs-on: ubuntu-latest
    timeout-minutes: 30       # Giới hạn chạy tối đa 30 phút

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: 🐋 Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: 🚀 Run Nexus Testnet Node
        env:
          NODE_ID: 25642744
        run: |
          echo "============================================"
          echo "🚀 Starting Nexus Testnet Node"
          echo "🔹 Node ID: $NODE_ID"
          echo "🔹 Network: testnet"
          echo "============================================"

          # Kéo image mới nhất
          docker pull nexuschain/nexus-node:latest || echo "⚠️ Failed to pull image"

          # Dừng và xóa container cũ (nếu có)
          docker ps -a | grep nexus-node && docker rm -f nexus-node || echo "No previous container"

          # Chạy node
          docker run -d --name nexus-node \
            -e NODE_ID=$NODE_ID \
            -p 8545:8545 \
            -p 30303:30303 \
            nexuschain/nexus-node:latest --network testnet || echo "❌ Failed to start container"

          echo "🕓 Waiting for node to initialize..."
          sleep 25

          echo "📜 Checking logs..."
          docker logs nexus-node || echo "⚠️ No logs found yet"

          # Kiểm tra node có đang chạy không
          if [ "$(docker inspect -f '{{.State.Running}}' nexus-node)" != "true" ]; then
            echo "❌ Node seems to have stopped. Restarting..."
            docker restart nexus-node
            sleep 20
            docker logs nexus-node || echo "⚠️ No logs found after restart"
          else
            echo "✅ Node is running successfully!"
          fi

          echo "============================================"
          echo "✅ Nexus Node job completed"
          echo "============================================"
